<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>History - Smart Gym</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global API URL - Use local proxy for development
        const API_BASE_URL = 'https://smartgym-m.azurewebsites.net';
        const REMOTE_API_URL = 'https://smartgym-m.azurewebsites.net';
        
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('time').innerText = `${hours} : ${minutes}`;

            let greeting = "GOOD MORNING";
            if (hours >= 12 && hours < 18) greeting = "GOOD AFTERNOON";
            else if (hours >= 18) greeting = "GOOD EVENING";
            document.getElementById('greeting').innerText = greeting;

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date').innerText = now.toLocaleDateString('en-US', options).toUpperCase();
        }
        
        // Chart objects
        let temperatureChart;
        let humidityChart;
        let occupancyChart;
        
        // Current time range
        let currentRange = '24h';
        
        window.onload = function() {
            updateTime();
            setInterval(updateTime, 60000); // Update time every minute
            
            // Load user data
            loadUserData();
            
            // Initialize charts
            initCharts();
            
            // Load data for default time range (24h)
            fetchHistoricalData('24h');
        };
        
        function loadUserData() {
            // Get user data from localStorage
            const userInfo = JSON.parse(localStorage.getItem('userInfo')) || {
                username: "Guest User",
                name: "Guest User",
                customerNumber: "000000"
            };
            
            // Display user data
            document.getElementById('userName').innerText = userInfo.name;
            document.getElementById('customerNumber').innerText = userInfo.customerNumber;
        }
        
        function initCharts() {
            // Temperature Chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 4,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Humidity Chart
            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#10b981',
                        pointRadius: 4,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Occupancy Chart
            const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
            occupancyChart = new Chart(occupancyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Occupancy',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#f59e0b',
                        pointRadius: 4,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        async function fetchHistoricalData(timeRange) {
            // Update active button
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500');
                btn.classList.add('bg-gray-700');
            });
            document.getElementById(`${timeRange}Btn`).classList.remove('bg-gray-700');
            document.getElementById(`${timeRange}Btn`).classList.add('bg-blue-500');
            
            // Update current range
            currentRange = timeRange;
            
            // Show loading state
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.add('opacity-50');
            });
            
            try {
                // Get authentication token if available
                const token = localStorage.getItem('token');
                const headers = {
                    'Accept': 'application/json'
                };
                
                // Add authorization header if token exists
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Fetch all sensor data from the new endpoint
                const response = await fetch(`${API_BASE_URL}/sensors`, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`API responded with error status`);
                }
                
                const allSensorData = await response.json();
                
                // Filter data based on time range
                const filteredData = filterDataByTimeRange(allSensorData, timeRange);
                
                // Process and display data
                updateCharts(filteredData);
                
                // Hide loading state
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.classList.remove('opacity-50');
                });
            } catch (error) {
                console.error('Error fetching historical data:', error);
                
                // Use fallback data
                useFallbackData(timeRange);
                
                // Hide loading state
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.classList.remove('opacity-50');
                });
            }
        }
        
        function filterDataByTimeRange(data, timeRange) {
            const now = new Date();
            let startDate = new Date();
            
            if (timeRange === '24h') {
                startDate.setDate(startDate.getDate() - 1);
            } else if (timeRange === '7d') {
                startDate.setDate(startDate.getDate() - 7);
            } else if (timeRange === '30d') {
                startDate.setDate(startDate.getDate() - 30);
            }
            
            // Filter data by date and type
            const tempData = data.filter(item => 
                item.type === 'temperature' && 
                new Date(item.timestamp) >= startDate && 
                new Date(item.timestamp) <= now
            );
            
            const humidityData = data.filter(item => 
                item.type === 'humidity' && 
                new Date(item.timestamp) >= startDate && 
                new Date(item.timestamp) <= now
            );
            
            const peopleCountData = data.filter(item => 
                item.type === 'peoplecount' && 
                new Date(item.timestamp) >= startDate && 
                new Date(item.timestamp) <= now
            );
            
            return {
                temperature: tempData,
                humidity: humidityData,
                peopleCount: peopleCountData
            };
        }
        
        function updateCharts(filteredData) {
            // Check if we have data
            if (!filteredData.temperature.length && !filteredData.humidity.length && !filteredData.peopleCount.length) {
                useFallbackData(currentRange);
                return;
            }
            
            // Process temperature data
            const tempLabels = [];
            const tempValues = [];
            
            // Sort data by timestamp (oldest to newest)
            filteredData.temperature.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Extract data for charts
            filteredData.temperature.forEach(item => {
                const date = new Date(item.timestamp);
                tempLabels.push(formatDateLabel(date, currentRange));
                tempValues.push(item.value);
            });
            
            // Process humidity data
            const humidityLabels = [];
            const humidityValues = [];
            
            // Sort data by timestamp (oldest to newest)
            filteredData.humidity.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Extract data for charts
            filteredData.humidity.forEach(item => {
                const date = new Date(item.timestamp);
                humidityLabels.push(formatDateLabel(date, currentRange));
                humidityValues.push(item.value);
            });
            
            // Process people count data
            const occupancyLabels = [];
            const occupancyValues = [];
            
            // Sort data by timestamp (oldest to newest)
            filteredData.peopleCount.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Extract data for charts
            filteredData.peopleCount.forEach(item => {
                const date = new Date(item.timestamp);
                occupancyLabels.push(formatDateLabel(date, currentRange));
                occupancyValues.push(item.value);
            });
            
            // Update temperature chart
            temperatureChart.data.labels = tempLabels;
            temperatureChart.data.datasets[0].data = tempValues;
            temperatureChart.update();
            
            // Update humidity chart
            humidityChart.data.labels = humidityLabels;
            humidityChart.data.datasets[0].data = humidityValues;
            humidityChart.update();
            
            // Update occupancy chart
            occupancyChart.data.labels = occupancyLabels;
            occupancyChart.data.datasets[0].data = occupancyValues;
            occupancyChart.update();
        }
        
        function formatDateLabel(date, timeRange) {
            if (timeRange === '24h') {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (timeRange === '7d') {
                return date.toLocaleDateString([], { weekday: 'short', month: 'numeric', day: 'numeric' });
            } else {
                return date.toLocaleDateString([], { month: 'numeric', day: 'numeric' });
            }
        }
        
        function useFallbackData(timeRange) {
            // Generate fallback data based on time range
            const labels = [];
            const temperatures = [];
            const humidities = [];
            const occupancies = [];
            
            const now = new Date();
            let dataPoints = 0;
            
            if (timeRange === '24h') {
                dataPoints = 24;
                for (let i = 0; i < dataPoints; i++) {
                    const date = new Date(now);
                    date.setHours(date.getHours() - (dataPoints - i));
                    labels.push(date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    temperatures.push(20 + Math.random() * 5);
                    humidities.push(40 + Math.random() * 20);
                    occupancies.push(Math.floor(Math.random() * 30));
                }
            } else if (timeRange === '7d') {
                dataPoints = 7;
                for (let i = 0; i < dataPoints; i++) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - (dataPoints - i - 1));
                    labels.push(date.toLocaleDateString([], { weekday: 'short', month: 'numeric', day: 'numeric' }));
                    temperatures.push(20 + Math.random() * 5);
                    humidities.push(40 + Math.random() * 20);
                    occupancies.push(Math.floor(Math.random() * 30));
                }
            } else {
                dataPoints = 30;
                for (let i = 0; i < dataPoints; i++) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - (dataPoints - i - 1));
                    labels.push(date.toLocaleDateString([], { month: 'numeric', day: 'numeric' }));
                    temperatures.push(20 + Math.random() * 5);
                    humidities.push(40 + Math.random() * 20);
                    occupancies.push(Math.floor(Math.random() * 30));
                }
            }
            
            // Update temperature chart
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = temperatures;
            temperatureChart.update();
            
            // Update humidity chart
            humidityChart.data.labels = labels;
            humidityChart.data.datasets[0].data = humidities;
            humidityChart.update();
            
            // Update occupancy chart
            occupancyChart.data.labels = labels;
            occupancyChart.data.datasets[0].data = occupancies;
            occupancyChart.update();
        }
        
        function logout() {
            // Keep the user info in localStorage but set as guest
            const guestInfo = {
                username: "Guest User",
                name: "Guest User",
                email: "",
                customerNumber: "000000"
            };
            localStorage.setItem('userInfo', JSON.stringify(guestInfo));
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
        
        // Chatbot functions
        function toggleChatbot() {
            const chatbotContainer = document.getElementById('chatbot-container');
            if (chatbotContainer.classList.contains('hidden')) {
                chatbotContainer.classList.remove('hidden');
                document.getElementById('chat-button').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
            } else {
                chatbotContainer.classList.add('hidden');
                document.getElementById('chat-button').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>';
            }
        }
    </script>
    <style>
        body {
            background: url('https://i.ibb.co/Z1dTcNGx/Screenshot-2025-02-28-205107.png') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            transition: opacity 0.3s ease;
        }
        
        /* Chatbot styles */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .chat-button:hover {
            transform: scale(1.05);
            background-color: #2563eb;
        }
        
        .chatbot-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 400px;
            height: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 999;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 640px) {
            .chatbot-container {
                width: 90%;
                height: 80%;
                bottom: 80px;
                right: 5%;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center text-white min-h-screen relative">
    <!-- Top Section: Logo, Greeting, Time & Date -->
    <div class="absolute top-6 left-6 flex items-center">
        <a href="index.html" class="flex items-center">
            <img src="https://i.ibb.co/CpW0wPZG/Screenshot-2025-02-28-205044.png" alt="Logo" class="h-14 w-14 mr-3">
            <h1 class="text-3xl font-bold text-blue-400">SMART GYM</h1>
        </a>
    </div>
    
    <div class="absolute top-6 right-6 flex space-x-6 text-xl">
        <h1 id="greeting" class="font-bold text-3xl uppercase">GOOD MORNING</h1>
        <p id="time" class="text-3xl font-bold">07 : 35</p>
        <h2 id="date" class="text-blue-400">SATURDAY MARCH 1, 2025</h2>
    </div>
    
    <!-- Main Content -->
    <div class="w-full max-w-6xl mx-auto mt-32 mb-16 px-4">
        <div class="bg-gray-900 bg-opacity-75 p-8 rounded-lg">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl text-blue-400 font-bold">HISTORICAL DATA</h2>
                
                <!-- User Info -->
                <div class="flex flex-col items-end mt-4 md:mt-0">
                    <p class="text-xl" id="userName">Loading...</p>
                    <p class="text-sm">CUSTOMER NUMBER: <span id="customerNumber">Loading...</span></p>
                </div>
            </div>
            
            <!-- Time Range Selector -->
            <div class="flex justify-center mb-8">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button id="24hBtn" type="button" class="px-4 py-2 text-sm font-medium bg-blue-500 text-white rounded-l-lg time-range-btn" onclick="fetchHistoricalData('24h')">
                        24 Hours
                    </button>
                    <button id="7dBtn" type="button" class="px-4 py-2 text-sm font-medium bg-gray-700 text-white time-range-btn" onclick="fetchHistoricalData('7d')">
                        7 Days
                    </button>
                    <button id="30dBtn" type="button" class="px-4 py-2 text-sm font-medium bg-gray-700 text-white rounded-r-lg time-range-btn" onclick="fetchHistoricalData('30d')">
                        30 Days
                    </button>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Temperature Chart -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl text-blue-400 mb-4">Temperature</h3>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
                
                <!-- Humidity Chart -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl text-blue-400 mb-4">Humidity</h3>
                    <div class="chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>
                
                <!-- Occupancy Chart -->
                <div class="bg-gray-800 p-4 rounded-lg md:col-span-2">
                    <h3 class="text-xl text-blue-400 mb-4">Occupancy</h3>
                    <div class="chart-container">
                        <canvas id="occupancyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-8">
                <button type="button" onclick="window.location.href='index.html'" class="px-6 py-3 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition-colors">
                    BACK TO DASHBOARD
                </button>
                
                <button type="button" onclick="logout()" class="px-6 py-3 bg-blue-400 text-white rounded-md hover:bg-blue-500 transition-colors">
                    LOG OUT
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer: Contact Information -->
    <div class="absolute bottom-6 left-6 text-sm">
        <p class="text-blue-400 font-bold">LOMAKYL√Ñ RAKKARANTA</p>
        <p>üìû 050 400 0373</p>
        <p>üìç Nelj√§s Avenjuu 3, 89400 Hyrynsalmi</p>
    </div>
    
    <!-- Chatbot Button -->
    <div id="chat-button" class="chat-button" onclick="toggleChatbot()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
    </div>
    
    <!-- Chatbot Container -->
    <div id="chatbot-container" class="chatbot-container hidden">
        <iframe
            src="https://www.chatbase.co/chatbot-iframe/gxnSSIINfvC7w_miir5U7"
            width="100%"
            height="100%"
            frameborder="0"
            allow="microphone"
            sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
        ></iframe>
    </div>
</body>
</html>
